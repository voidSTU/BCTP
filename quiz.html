<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BCTP - éœ¸å‡Œè¡Œç‚ºæ¸¬é©—</title>
<link rel="stylesheet" href="style.css">
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“š</text></svg>">
<style>
  .quiz-question { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
  #score-box { margin-top: 20px; font-size: 1.2em; font-weight: bold; }
</style>
</head>
<body>
<header>
  <div class="container">
    <h1>BCTP æ¸¬é©—</h1>
    <p>è«‹å›ç­”ä»¥ä¸‹å•é¡Œï¼Œé” 60 åˆ†æ‰èƒ½é€²å…¥åæ€è¡¨å–®ã€‚</p>
  </div>
</header>

<main>
  <div class="container">
    <div id="quiz-container"></div>

    <button id="next-btn" class="btn-animated btn-green">
      <span class="default-text">ä¸‹ä¸€æ­¥ï¼šåæ€è¡¨å–® â†’</span>
      <span class="hover-text">æäº¤æ¸¬é©—</span>
    </button>

    <div id="score-box"></div>
  </div>
</main>

<footer>
  <p>BCTP (Bullying Consequence Transparency Platform)</p>
</footer>

<script>
document.addEventListener('DOMContentLoaded', async function() {
  const QUIZ_JSON_URL = 'https://raw.githubusercontent.com/voidSTU/BCTP/main/QuizJson.json';  // ç”¨ä½ æä¾›çš„ JSON é€£çµ
  const quizContainer = document.getElementById('quiz-container');
  const nextBtn = document.getElementById('next-btn');
  const scoreBox = document.getElementById('score-box');

  let quizQuestions = [];
  let score = 0;

  // å¾ localStorage è®€å–é¸æ“‡çš„è¡Œç‚ºé¡å‹
  const selectedQuestionTypes = JSON.parse(localStorage.getItem('selectedQuestionTypes') || '[]');
  if (!selectedQuestionTypes.length) {
    alert('æœªé¸æ“‡è¡Œç‚ºé¡å‹ï¼Œå°‡è¿”å›è¡Œç‚ºå‹¾é¸é ');
    window.location.href = 'query.html';
    return;
  }

  try {
    const res = await fetch(QUIZ_JSON_URL);
    if (!res.ok) throw new Error(`Failed to fetch JSON: ${res.status} ${res.statusText}`);
    const data = await res.json();

    // å°‡é¡Œç›®ä¾ questionType åˆ†çµ„
    const groupedByType = {};
    selectedQuestionTypes.forEach(type => {
      groupedByType[type] = data.questions.filter(q => q.questionType === type);
    });

    // å¹³å‡åˆ†é…é¡Œç›®ï¼Œæ¯é¡å‹é¡Œç›®æ•¸é‡
    const totalQuestions = 10;
    const typeCount = selectedQuestionTypes.length;
    const baseCount = Math.floor(totalQuestions / typeCount);
    let remainder = totalQuestions % typeCount;

    // æŠ½é¡Œ
    quizQuestions = [];
    selectedQuestionTypes.forEach(type => {
      let typeQuestions = groupedByType[type].slice(); // è¤‡è£½é™£åˆ—
      // éš¨æ©Ÿæ’åº
      typeQuestions.sort(() => 0.5 - Math.random());
      let count = baseCount + (remainder > 0 ? 1 : 0);
      remainder--;
      quizQuestions.push(...typeQuestions.slice(0, count));
    });

    // è‹¥ç¸½é¡Œæ•¸ä¸è¶³ 10ï¼Œå¾å„é¡å‹è£œè¶³
    if (quizQuestions.length < totalQuestions) {
      let shortage = totalQuestions - quizQuestions.length;
      const extraPool = [];
      Object.values(groupedByType).forEach(arr => extraPool.push(...arr));
      extraPool.sort(() => 0.5 - Math.random());
      quizQuestions.push(...extraPool.slice(0, shortage));
    }

    // å°‡é¡Œç›®æ‰“äº‚é †åº
    quizQuestions.sort(() => 0.5 - Math.random());

  } catch (err) {
    console.error('Error loading quiz data:', err);
    alert(`é¡Œåº«è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚è©³ç´°éŒ¯èª¤ï¼š${err.message}`);
    return;
  }

  // æ¸²æŸ“æ¸¬é©—é¡Œç›®
  function renderQuiz() {
    quizContainer.innerHTML = '';
    quizQuestions.forEach((q, idx) => {
      const div = document.createElement('div');
      div.className = 'quiz-question';
      div.innerHTML = `<h3>${idx+1}. ${q.question}</h3>`;

      // é¸é …éš¨æ©Ÿæ’åº
      const options = q.options.slice();
      options.sort(() => 0.5 - Math.random());

      options.forEach((opt, i) => {
        const label = document.createElement('label');
        label.innerHTML = `<input type="radio" name="q${idx}" value="${q.options.indexOf(opt)}"> ${opt}`;
        div.appendChild(label);
        div.appendChild(document.createElement('br'));
      });

      quizContainer.appendChild(div);
    });
    scoreBox.textContent = '';
  }

  renderQuiz();

  // ä¸‹ä¸€æ­¥æŒ‰éˆ•äº‹ä»¶
  nextBtn.addEventListener('click', function() {
    score = 0;
    quizQuestions.forEach((q, idx) => {
      const selected = quizContainer.querySelector(`input[name="q${idx}"]:checked`);
      if (selected && Number(selected.value) === q.correctAnswerIndex) score += 10;
    });

    if (score >= 60) {
      localStorage.setItem('quizAnswers', JSON.stringify({
        questionTypes: selectedQuestionTypes,
        answers: quizQuestions.map((q, idx) => {
          const selected = quizContainer.querySelector(`input[name="q${idx}"]:checked`);
          return selected ? Number(selected.value) : null;
        })
      }));
      window.location.href = 'form.html';
    } else {
      alert(`æœªé” 60 åˆ†ï¼Œåˆ†æ•¸ï¼š${score} åˆ† â†’ é¡Œç›®å°‡é‡æ–°æ´—ç‰Œ`);
      scoreBox.textContent = `åˆ†æ•¸ï¼š${score} åˆ†ï¼Œè«‹é‡æ–°ç­”é¡Œ`;
      score = 0;
      // é‡æ–°æ’åºé¡Œç›®åŠé¸é …
      quizQuestions.forEach(q => q.options.sort(() => 0.5 - Math.random()));
      quizQuestions.sort(() => 0.5 - Math.random());
      renderQuiz();
    }
  });
});
</script>

</body>
</html>
